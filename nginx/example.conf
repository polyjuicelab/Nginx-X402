# Example Nginx configuration with x402 payment protection
#
# This configuration demonstrates how to use the x402 ngx-rust module to protect
# resources with HTTP micropayments.
#
# Prerequisites:
# 1. Build the module: cargo build --release
# 2. Load the module using ONE of these methods:
#    Option A: Symlink modules-enabled (Debian/Ubuntu):
#      sudo ln -s /etc/nginx/modules-available/x402.conf /etc/nginx/modules-enabled/x402.conf
#    Option B: Add load_module to nginx.conf:
#      load_module /usr/lib/nginx/modules/libnginx_x402.so;
# 3. Configure x402 directives as shown below
#
# IMPORTANT: Use ONLY ONE method to load the module. Using both will cause
# "module already loaded" errors.

http {
    # NOTE: If you're using Option B (manual load_module), add this line to
    # /etc/nginx/nginx.conf at the top level (before the http block):
    # load_module /usr/lib/nginx/modules/libnginx_x402.so;
    #
    # If you're using Option A (modules-enabled symlink), DO NOT add load_module
    # here - it's already loaded via /etc/nginx/modules-enabled/x402.conf

    # Upstream backend server
    upstream backend {
        server 127.0.0.1:8080;
    }

    server {
        listen 80;
        server_name example.com;

        # Protected location with x402 payment
        location /api/protected {
            # Enable x402 payment protection
            x402 on;
            
            # Payment configuration
            x402_amount 0.0001;  # 0.0001 USDC
            x402_pay_to 0x209693Bc6afc0C5328bA36FaF03C514EF312287C;
            x402_facilitator_url https://x402.org/facilitator;
            x402_network base-sepolia;  # Use testnet
            x402_facilitator_fallback error;  # Return 500 if facilitator fails (default)
            x402_description "API access payment";
            
            # Proxy to backend after payment verification
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Public location (no payment required)
        location / {
            root /var/www/html;
            index index.html;
        }

        # Health check endpoint (no payment)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Prometheus metrics endpoint (no payment required)
        # This endpoint exposes Prometheus metrics for monitoring with Grafana
        location /metrics {
            x402_metrics on;
            access_log off;  # Optional: disable access logging for metrics endpoint
        }
    }

    # Example with different payment amounts per location
    server {
        listen 8080;
        server_name api.example.com;

        # Premium API - higher payment amount
        location /api/premium {
            x402 on;
            x402_amount 0.01;
            x402_pay_to 0x209693Bc6afc0C5328bA36FaF03C514EF312287C;
            x402_facilitator_url https://x402.org/facilitator;
            x402_network base;  # Use mainnet
            x402_description "Premium API access";
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }

        # Standard API - lower payment amount
        location /api/standard {
            x402 on;
            x402_amount 0.0001;
            x402_pay_to 0x209693Bc6afc0C5328bA36FaF03C514EF312287C;
            x402_facilitator_url https://x402.org/facilitator;
            x402_network base-sepolia;  # Use testnet
            x402_facilitator_fallback pass;  # Pass through if facilitator fails
            x402_description "Standard API access";
            
            proxy_pass http://backend;
            proxy_set_header Host $host;
        }
    }
}

