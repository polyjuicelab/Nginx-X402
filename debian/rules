#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CARGO_PACKAGE = nginx-x402
export DEB_CARGO_BUILD_PROFILE = release

%:
	dh $@

override_dh_auto_build:
	# Don't build during package creation - build happens during installation (postinst)
	# This allows the module to be compiled against the actual system nginx version
	echo "Skipping build during package creation - will build during installation"

override_dh_auto_install:
	# Install source code and documentation - module will be built during installation
	mkdir -p debian/nginx-x402/usr/lib/nginx/modules
	mkdir -p debian/nginx-x402/usr/share/doc/nginx-x402
	mkdir -p debian/nginx-x402/etc/nginx/modules-available
	mkdir -p debian/nginx-x402/usr/share/nginx-x402/src
	# Copy source code for building during installation
	cp -r src debian/nginx-x402/usr/share/nginx-x402/
	cp -r build.rs debian/nginx-x402/usr/share/nginx-x402/ 2>/dev/null || true
	cp Cargo.toml debian/nginx-x402/usr/share/nginx-x402/
	# Copy README.md (needed for doc generation in src/lib.rs)
	cp README.md debian/nginx-x402/usr/share/nginx-x402/ 2>/dev/null || true
	# Don't copy Cargo.lock - let cargo regenerate it during installation
	# This avoids lock file version compatibility issues
	# Copy documentation
	cp README.md debian/nginx-x402/usr/share/doc/nginx-x402/
	cp LICENSE debian/nginx-x402/usr/share/doc/nginx-x402/
	cp nginx/example.conf debian/nginx-x402/usr/share/doc/nginx-x402/example.conf
	# Create module configuration snippet
	echo "load_module /usr/lib/nginx/modules/libnginx_x402.so;" > debian/nginx-x402/etc/nginx/modules-available/x402.conf

override_dh_auto_test:
	# Run tests (vendored feature is enabled by default)
	cargo test || true
